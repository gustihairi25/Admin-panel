<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Hub V4 | Admin Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap');
        
        :root {
            --vh: 1vh;
        }

        body { 
            background: #000; 
            color: #eee; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            /* Menghitung tinggi layar asli Android (minus navbar browser) */
            height: calc(var(--vh, 1vh) * 100); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        
        /* Container Konten Utama */
        #main-viewport {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px; /* Ruang untuk navigasi bawah jika ada */
        }

        .tab-content { display: none; width: 100%; height: 100%; }
        .tab-active { display: flex; flex-direction: column; }
        
        .active-nav { color: #f3ba2f; position: relative; }
        .active-nav::after {
            content: '';
            position: absolute;
            bottom: -5px; left: 0; right: 0;
            height: 2px; background: #f3ba2f;
            box-shadow: 0 0 10px #f3ba2f;
        }

        .chat-bubble-admin { background: #f3ba2f; color: #000; align-self: flex-end; border-radius: 12px 12px 2px 12px; font-weight: 700; }
        .chat-bubble-user { background: #1a1a1a; color: #fff; align-self: flex-start; border-radius: 12px 12px 12px 2px; border: 1px solid #333; }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4">

    <header class="flex justify-between items-center mb-6 shrink-0">
        <div>
            <h1 class="text-xl font-black italic tracking-tighter leading-none">MASTER <span class="text-[#f3ba2f]">HUB</span></h1>
            <p class="text-[8px] font-bold text-gray-500 uppercase tracking-widest mt-1">Admin Control Pro</p>
        </div>
        <div class="flex items-center gap-1 bg-green-500/10 px-2 py-1 rounded-full border border-green-500/20">
            <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-[7px] font-bold text-green-500 uppercase italic">Online</span>
        </div>
    </header>

    <nav class="flex gap-6 mb-6 overflow-x-auto no-scrollbar shrink-0 border-b border-white/5">
        <button onclick="st('market')" id="n-market" class="active-nav pb-2 text-[10px] font-black uppercase whitespace-nowrap transition-all">Market</button>
        <button onclick="st('users')" id="n-users" class="pb-2 text-[10px] font-black uppercase whitespace-nowrap transition-all">Manage & Saldo</button>
        <button onclick="st('chats')" id="n-chats" class="pb-2 text-[10px] font-black uppercase whitespace-nowrap transition-all">Live Chat</button>
    </nav>

    <div id="main-viewport" class="no-scrollbar">

        <div id="t-market" class="tab-content tab-active space-y-4">
            <div class="glass p-6 rounded-[2rem] space-y-4">
                <p class="text-[9px] font-black text-yellow-500 uppercase">Price Manipulation</p>
                <div class="flex gap-2">
                    <input type="number" id="offset-input" class="flex-1 bg-black border border-white/10 p-4 rounded-2xl text-xs font-bold outline-none focus:border-yellow-500" placeholder="Offset Harga...">
                    <button onclick="applyOffset()" class="bg-yellow-500 text-black px-6 rounded-2xl font-black text-[10px] uppercase">Set</button>
                </div>
            </div>
            <div class="glass p-6 rounded-[2rem] space-y-4">
                <p class="text-[9px] font-black text-yellow-500 uppercase">Global Result Mode</p>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setGlobal('win')" class="bg-green-600/20 text-green-500 py-3 rounded-xl font-black text-[9px]">WIN</button>
                    <button onclick="setGlobal('normal')" class="bg-white/5 text-gray-400 py-3 rounded-xl font-black text-[9px]">NORMAL</button>
                    <button onclick="setGlobal('loss')" class="bg-red-600/20 text-red-500 py-3 rounded-xl font-black text-[9px]">LOSS</button>
                </div>
            </div>
        </div>

        <div id="t-users" class="tab-content space-y-4">
            <div id="user-grid" class="grid grid-cols-1 gap-4">
                </div>
        </div>

        <div id="t-chats" class="tab-content h-full">
            <div class="flex flex-col gap-4 h-full">
                <div class="flex gap-2 overflow-x-auto no-scrollbar shrink-0" id="contact-list"></div>
                
                <div class="flex-1 glass rounded-[2rem] flex flex-col overflow-hidden">
                    <div id="chat-target" class="p-3 border-b border-white/5 font-black text-[10px] text-yellow-500 uppercase italic">Pilih Kontak</div>
                    <div id="chat-window" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 no-scrollbar text-xs"></div>
                    <div class="p-3 bg-black/60 flex gap-2 border-t border-white/5">
                        <input type="text" id="msg-input" class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs outline-none" placeholder="Balas...">
                        <button onclick="sendMsg()" class="bg-yellow-500 text-black w-10 h-10 rounded-xl flex items-center justify-center shrink-0"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, setDoc, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);

        let activeUID = "";
        const COINS = ['BTC', 'ETH', 'BNB', 'TRX'];

        // --- FIX VIEWPORT ANDROID ---
        const resizeVH = () => {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        };
        window.addEventListener('resize', resizeVH);
        resizeVH();

        // --- NAVIGATION LOGIC ---
        window.st = (t) => {
            // Sembunyikan semua tab
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('tab-active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active-nav'));
            
            // Tampilkan tab pilihan
            const targetTab = document.getElementById('t-' + t);
            const targetNav = document.getElementById('n-' + t);
            
            if(targetTab && targetNav) {
                targetTab.classList.add('tab-active');
                targetNav.classList.add('active-nav');
            }
        };

        const toIDR = (num) => new Intl.NumberFormat('id-ID').format(num);

        // --- DATABASE ACTIONS ---
        window.applyOffset = async () => {
            const val = parseFloat(document.getElementById('offset-input').value) || 0;
            await setDoc(doc(db, "system", "market_control"), { offset: val }, { merge: true });
            alert("Offset Updated!");
        };

        window.setGlobal = async (m) => {
            await setDoc(doc(db, "system", "market_control"), { mode: m }, { merge: true });
            alert("Global: " + m);
        };

        window.updateSaldo = async (uid, val) => {
            const raw = parseInt(val.replace(/[^0-9]/g, '')) || 0;
            await updateDoc(doc(db, "users", uid), { balance: raw });
        };

        window.updateCoin = async (uid, coin, val) => {
            const key = `${coin.toLowerCase()}_bal`;
            const up = {}; up[key] = parseFloat(val) || 0;
            await updateDoc(doc(db, "users", uid), up);
        };

        window.forceUser = async (uid, mode) => {
            await updateDoc(doc(db, "users", uid), { next_trade: mode });
            alert("Target: " + mode);
        };

        // --- CHAT LOGIC ---
        window.openChat = (uid, email) => {
            activeUID = uid;
            document.getElementById('chat-target').innerText = email;
            updateDoc(doc(db, "users", uid), { lastRead: true });
            
            onSnapshot(query(collection(db, "users", uid, "chats"), orderBy("timestamp", "asc")), (sn) => {
                const win = document.getElementById('chat-window');
                win.innerHTML = '';
                sn.forEach(d => {
                    const m = d.data();
                    win.innerHTML += `<div class="p-3 mb-2 max-w-[85%] ${m.sender === 'admin' ? 'chat-bubble-admin' : 'chat-bubble-user'}">${m.text}</div>`;
                });
                win.scrollTop = win.scrollHeight;
            });
        };

        window.sendMsg = async () => {
            const inp = document.getElementById('msg-input');
            if(!activeUID || !inp.value.trim()) return;
            const t = inp.value; inp.value = '';
            await addDoc(collection(db, "users", activeUID, "chats"), { sender: 'admin', text: t, timestamp: serverTimestamp() });
            await updateDoc(doc(db, "users", activeUID), { lastMsgBy: 'admin', lastRead: true });
        };

        // --- REALTIME RENDERER ---
        onSnapshot(collection(db, "users"), (snap) => {
            const grid = document.getElementById('user-grid');
            const clist = document.getElementById('contact-list');
            grid.innerHTML = ''; clist.innerHTML = '';

            snap.forEach(s => {
                const u = s.data();
                const id = s.id;
                const email = u.email || "No Email";

                // Card User Management
                let coins = '';
                COINS.forEach(c => {
                    coins += `
                    <div class="flex justify-between items-center bg-black/40 p-2 rounded-xl mb-1 border border-white/5">
                        <span class="text-[8px] font-bold text-gray-500 uppercase">${c}</span>
                        <input type="number" step="any" onchange="updateCoin('${id}','${c}',this.value)" value="${u[c.toLowerCase()+'_bal'] || 0}" class="bg-transparent text-right text-[10px] text-yellow-500 outline-none w-20">
                    </div>`;
                });

                grid.innerHTML += `
                <div class="glass p-5 rounded-[2rem] space-y-4">
                    <div class="flex justify-between items-center">
                        <p class="text-[10px] font-black text-gray-400 truncate w-32">${email}</p>
                        <div class="flex gap-1">
                            <button onclick="forceUser('${id}','win')" class="px-3 py-1 bg-green-500/10 text-green-500 text-[8px] font-black rounded-lg border border-green-500/20">WIN</button>
                            <button onclick="forceUser('${id}','loss')" class="px-3 py-1 bg-red-500/10 text-red-500 text-[8px] font-black rounded-lg border border-red-500/20">LOSS</button>
                        </div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <p class="text-[7px] font-black text-gray-500 uppercase mb-1">Saldo IDR</p>
                        <div class="flex items-center gap-1 font-black text-yellow-500">
                            <span class="text-xs">Rp</span>
                            <input type="text" value="${toIDR(u.balance || 0)}" 
                                oninput="this.value = toIDR(this.value.replace(/[^0-9]/g,'')); updateSaldo('${id}', this.value)" 
                                class="bg-transparent text-sm w-full outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">${coins}</div>
                </div>`;

                // Card Chat Contacts
                const isUnread = u.lastMsgBy === 'user' && u.lastRead === false;
                const cDiv = document.createElement('div');
                cDiv.className = `p-3 px-5 rounded-2xl cursor-pointer flex items-center gap-2 shrink-0 border transition-all ${activeUID === id ? 'bg-yellow-500 border-yellow-500 text-black' : 'bg-white/5 border-white/5 text-gray-400'}`;
                cDiv.innerHTML = `<span class="text-[9px] font-black uppercase whitespace-nowrap">${email.split('@')[0]}</span> ${isUnread ? '<span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>' : ''}`;
                cDiv.onclick = () => openChat(id, email);
                clist.appendChild(cDiv);
            });
        });

        // Init
        lucide.createIcons();
        document.getElementById('msg-input').onkeydown = (e) => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
