<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Hub Pro | Fix Navigation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap');
        
        :root { --vh: 1vh; }
        body { 
            background: #000; color: #eee; font-family: 'Plus Jakarta Sans', sans-serif; 
            height: calc(var(--vh, 1vh) * 100); overflow: hidden; display: flex; flex-direction: column;
        }

        /* Navigasi Styling */
        .nav-btn { position: relative; padding-bottom: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #666; transition: 0.3s; }
        .nav-btn.active { color: #f3ba2f; }
        .nav-btn.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0;
            height: 2px; background: #f3ba2f; box-shadow: 0 0 10px #f3ba2f;
        }

        /* Tab Visibility - Dipaksa dengan !important */
        .tab-panel { display: none !important; width: 100%; height: 100%; flex-direction: column; }
        .tab-panel.active { display: flex !important; }

        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Chat bubbles */
        .bubble-admin { background: #f3ba2f; color: #000; align-self: flex-end; border-radius: 12px 12px 2px 12px; font-size: 11px; padding: 10px; font-weight: 700; }
        .bubble-user { background: #1a1a1a; color: #fff; align-self: flex-start; border-radius: 12px 12px 12px 2px; border: 1px solid #333; font-size: 11px; padding: 10px; }
    </style>
</head>
<body class="p-4">

    <header class="flex justify-between items-center mb-6 shrink-0">
        <h1 class="text-xl font-black italic tracking-tighter">MASTER <span class="text-[#f3ba2f]">HUB</span></h1>
        <div class="bg-white/5 px-3 py-1 rounded-full border border-white/10 text-[8px] font-bold uppercase tracking-widest">Admin Console</div>
    </header>

    <nav class="flex gap-6 mb-4 border-b border-white/5 shrink-0 overflow-x-auto no-scrollbar">
        <button onclick="changeTab('market')" id="btn-market" class="nav-btn active">Market</button>
        <button onclick="changeTab('users')" id="btn-users" class="nav-btn">Manage & Saldo</button>
        <button onclick="changeTab('chats')" id="btn-chats" class="nav-btn">Live Chat</button>
    </nav>

    <div id="content-container" class="flex-1 overflow-hidden relative">

        <div id="pane-market" class="tab-panel active space-y-4 overflow-y-auto no-scrollbar">
            <div class="glass p-6 rounded-[2rem] space-y-4">
                <p class="text-[9px] font-black text-yellow-500 uppercase">Market Control</p>
                <input type="number" id="offset-val" class="w-full bg-black border border-white/10 p-4 rounded-2xl text-xs font-bold outline-none" placeholder="Offset Harga...">
                <button onclick="saveOffset()" class="w-full bg-yellow-500 text-black py-4 rounded-2xl font-black uppercase text-[10px]">Update Market</button>
            </div>
            <div class="glass p-6 rounded-[2rem] space-y-4">
                <p class="text-[9px] font-black text-yellow-500 uppercase">Global Result Mode</p>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setGlobal('win')" class="bg-green-600/20 text-green-500 py-3 rounded-xl font-black text-[9px]">WIN</button>
                    <button onclick="setGlobal('normal')" class="bg-white/5 text-gray-400 py-3 rounded-xl font-black text-[9px]">NORMAL</button>
                    <button onclick="setGlobal('loss')" class="bg-red-600/20 text-red-500 py-3 rounded-xl font-black text-[9px]">LOSS</button>
                </div>
            </div>
        </div>

        <div id="pane-users" class="tab-panel space-y-4 overflow-y-auto no-scrollbar">
            <div id="list-user-management" class="space-y-4">
                </div>
        </div>

        <div id="pane-chats" class="tab-panel">
            <div class="flex flex-col h-full gap-3">
                <div id="chat-contacts" class="flex gap-2 overflow-x-auto no-scrollbar shrink-0"></div>
                <div class="flex-1 glass rounded-[2rem] flex flex-col overflow-hidden">
                    <div id="active-target" class="p-3 border-b border-white/5 text-[9px] font-black text-yellow-500 uppercase italic">Pilih Kontak</div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 no-scrollbar"></div>
                    <div class="p-3 bg-black/60 flex gap-2 border-t border-white/5">
                        <input type="text" id="chat-input" class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs outline-none" placeholder="Ketik balasan...">
                        <button onclick="sendAdminMsg()" class="bg-yellow-500 text-black w-10 h-10 rounded-xl flex items-center justify-center shrink-0"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, setDoc, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);

        let currentUID = "";
        const COINS = ['BTC', 'ETH', 'BNB', 'TRX'];

        // --- FIXED NAVIGATION SYSTEM ---
        window.changeTab = (tabId) => {
            // Reset Nav Buttons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + tabId).classList.add('active');

            // Reset Tab Panes
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('pane-' + tabId).classList.add('active');
            
            console.log("Tab switched to:", tabId);
        };

        // --- BALANCE & USER LOGIC ---
        const formatIDR = (n) => new Intl.NumberFormat('id-ID').format(n);

        window.updateIDR = async (uid, val) => {
            const raw = parseInt(val.replace(/[^0-9]/g, '')) || 0;
            await updateDoc(doc(db, "users", uid), { balance: raw });
        };

        window.updateCrypto = async (uid, coin, val) => {
            const up = {}; up[`${coin.toLowerCase()}_bal`] = parseFloat(val) || 0;
            await updateDoc(doc(db, "users", uid), up);
        };

        window.setTarget = async (uid, mode) => {
            await updateDoc(doc(db, "users", uid), { next_trade: mode });
            alert("Target set to " + mode.toUpperCase());
        };

        // --- MARKET LOGIC ---
        window.saveOffset = async () => {
            const v = parseFloat(document.getElementById('offset-val').value) || 0;
            await setDoc(doc(db, "system", "market_control"), { offset: v }, { merge: true });
            alert("Market Updated!");
        };

        window.setGlobal = async (m) => {
            await setDoc(doc(db, "system", "market_control"), { mode: m }, { merge: true });
            alert("Global Mode: " + m);
        };

        // --- CHAT LOGIC ---
        window.openChat = (uid, email) => {
            currentUID = uid;
            document.getElementById('active-target').innerText = "CHAT: " + email;
            updateDoc(doc(db, "users", uid), { lastRead: true });
            
            onSnapshot(query(collection(db, "users", uid, "chats"), orderBy("timestamp", "asc")), (sn) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = '';
                sn.forEach(d => {
                    const m = d.data();
                    const b = document.createElement('div');
                    b.className = m.sender === 'admin' ? 'bubble-admin' : 'bubble-user';
                    b.innerText = m.text;
                    box.appendChild(b);
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendAdminMsg = async () => {
            const inp = document.getElementById('chat-input');
            if(!currentUID || !inp.value.trim()) return;
            const text = inp.value; inp.value = '';
            await addDoc(collection(db, "users", currentUID, "chats"), { sender: 'admin', text: text, timestamp: serverTimestamp() });
            await updateDoc(doc(db, "users", currentUID), { lastMsgBy: 'admin', lastRead: true });
        };

        // --- REALTIME SYNC (THE CORE) ---
        onSnapshot(collection(db, "users"), (snap) => {
            const userList = document.getElementById('list-user-management');
            const chatContacts = document.getElementById('chat-contacts');
            
            userList.innerHTML = ''; chatContacts.innerHTML = '';

            snap.forEach(s => {
                const u = s.data();
                const id = s.id;
                const email = u.email || "No Email";

                // Render Saldo Card
                let coinHtml = '';
                COINS.forEach(c => {
                    coinHtml += `
                    <div class="flex justify-between items-center bg-black/40 p-2 rounded-xl border border-white/5 mb-1">
                        <span class="text-[8px] font-black text-gray-500">${c}</span>
                        <input type="number" step="any" onchange="updateCrypto('${id}','${c}',this.value)" value="${u[c.toLowerCase()+'_bal'] || 0}" class="bg-transparent text-right text-[10px] text-yellow-500 outline-none w-20">
                    </div>`;
                });

                userList.innerHTML += `
                <div class="glass p-5 rounded-[2rem] border border-white/10">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-[9px] font-black text-gray-400 truncate w-32">${email}</p>
                        <div class="flex gap-1">
                            <button onclick="setTarget('${id}','win')" class="px-3 py-1 bg-green-500/10 text-green-500 text-[8px] font-black rounded-lg">WIN</button>
                            <button onclick="setTarget('${id}','loss')" class="px-3 py-1 bg-red-500/10 text-red-500 text-[8px] font-black rounded-lg">LOSS</button>
                        </div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl mb-4 border border-white/5">
                        <p class="text-[7px] text-gray-500 font-black uppercase mb-1">IDR BALANCE</p>
                        <div class="flex items-center gap-1">
                            <span class="text-xs text-yellow-500 font-black">Rp</span>
                            <input type="text" value="${formatIDR(u.balance || 0)}" 
                                oninput="this.value = formatIDR(this.value.replace(/[^0-9]/g,'')); updateIDR('${id}', this.value)" 
                                class="bg-transparent text-sm w-full font-black text-white outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">${coinHtml}</div>
                </div>`;

                // Render Chat Contacts
                const isNew = u.lastMsgBy === 'user' && u.lastRead === false;
                const contactBtn = document.createElement('div');
                contactBtn.className = `p-3 px-5 rounded-2xl cursor-pointer flex items-center gap-2 shrink-0 border transition-all ${currentUID === id ? 'bg-yellow-500 text-black border-yellow-500' : 'bg-white/5 text-gray-500 border-white/5'}`;
                contactBtn.innerHTML = `<span class="text-[9px] font-black uppercase">${email.split('@')[0]}</span> ${isNew ? '<span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>' : ''}`;
                contactBtn.onclick = () => { changeTab('chats'); openChat(id, email); };
                chatContacts.appendChild(contactBtn);
            });
        });

        // Initialize
        lucide.createIcons();
        window.addEventListener('resize', () => { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); });
        document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    </script>
</body>
</html>
