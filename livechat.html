<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap');
        body { background: #000; color: #eee; font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4">
    <div class="flex h-full gap-4 max-w-6xl mx-auto w-full overflow-hidden">
        <div class="w-1/3 glass rounded-[2rem] flex flex-col overflow-hidden">
            <div class="p-5 border-b border-white/5 font-black text-xs text-yellow-500 uppercase">Daftar Chat</div>
            <div id="contact-list" class="flex-1 overflow-y-auto p-2 no-scrollbar"></div>
        </div>

        <div class="flex-1 glass rounded-[2rem] flex flex-col overflow-hidden">
            <div id="chat-header" class="p-5 border-b border-white/5 font-bold text-xs italic">Pilih user untuk membalas</div>
            <div id="chat-box" class="flex-1 overflow-y-auto p-5 flex flex-col gap-3 no-scrollbar"></div>
            <div class="p-4 bg-black border-t border-white/5 flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs outline-none" placeholder="Tulis balasan...">
                <button onclick="kirimPesan()" class="bg-yellow-500 text-black px-6 rounded-xl font-black text-xs">KIRIM</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);
        let activeID = "";

        window.openChat = (uid, email) => {
            activeID = uid;
            document.getElementById('chat-header').innerText = `CHAT: ${email}`;
            updateDoc(doc(db, "users", uid), { lastRead: true });

            onSnapshot(query(collection(db, "users", uid, "chats"), orderBy("timestamp", "asc")), (sn) => {
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                sn.forEach(d => {
                    const m = d.data();
                    const isAdm = m.sender === 'admin';
                    box.innerHTML += `<div class="${isAdm ? 'self-end bg-yellow-500 text-black' : 'self-start bg-white/10 text-white'} p-3 rounded-2xl max-w-[80%] text-[11px] font-bold">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.kirimPesan = async () => {
            const inp = document.getElementById('chat-input');
            if(!activeID || !inp.value.trim()) return;
            const msg = inp.value; inp.value = '';
            await addDoc(collection(db, "users", activeID, "chats"), { sender: 'admin', text: msg, timestamp: serverTimestamp() });
        };

        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('contact-list');
            list.innerHTML = '';
            snap.forEach(s => {
                const u = s.data();
                const isNew = u.lastMsgBy === 'user' && u.lastRead === false;
                list.innerHTML += `
                <div onclick="openChat('${s.id}', '${u.email}')" class="p-4 mb-2 rounded-2xl cursor-pointer hover:bg-white/5 flex justify-between items-center transition-all">
                    <span class="text-[10px] font-bold truncate w-32">${u.email || 'User'}</span>
                    ${isNew ? '<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>' : ''}
                </div>`;
            });
        });
    </script>
</body>
</html>
