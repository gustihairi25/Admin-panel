<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Hub | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background: #000; color: #eee; font-family: sans-serif; }
        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
        .tab-content { display: none; }
        .active { display: block; }
        .nav-btn.active-nav { color: #f3ba2f; border-bottom: 2px solid #f3ba2f; }
    </style>
</head>
<body class="p-4">
    <header class="flex justify-between items-center mb-6">
        <h1 class="font-black text-xl italic uppercase">MASTER <span class="text-yellow-500">HUB</span></h1>
        <nav class="flex gap-4">
            <button onclick="st('user')" id="n-user" class="nav-btn active-nav text-[10px] font-bold uppercase py-2">Users</button>
            <button onclick="st('chat')" id="n-chat" class="nav-btn text-[10px] font-bold uppercase py-2">Chats</button>
            <button onclick="st('qris')" id="n-qris" class="nav-btn text-[10px] font-bold uppercase py-2">QRIS</button>
        </nav>
    </header>

    <div id="t-user" class="tab-content active space-y-4">
        <div id="user-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <div id="t-chat" class="tab-content h-[70vh]">
        <div class="flex h-full gap-4">
            <div id="contact-list" class="w-1/3 glass rounded-2xl p-2 overflow-y-auto"></div>
            <div class="flex-1 glass rounded-2xl flex flex-col p-4">
                <div id="chat-box" class="flex-1 overflow-y-auto space-y-2 mb-4"></div>
                <div class="flex gap-2">
                    <input type="text" id="admin-msg" class="flex-1 bg-white/5 p-3 rounded-xl outline-none text-xs">
                    <button onclick="sendReply()" class="bg-yellow-500 text-black px-4 rounded-xl font-bold">Kirim</button>
                </div>
            </div>
        </div>
    </div>

    <div id="t-qris" class="tab-content">
        <div class="max-w-md mx-auto glass p-6 rounded-3xl space-y-4 text-center">
            <select id="target-coin" class="w-full bg-black border border-white/10 p-4 rounded-xl text-white font-bold">
                <option value="qris_idr">QRIS UTAMA (IDR)</option>
                <option value="qris_btc">TOKEN BTC</option>
                <option value="qris_eth">TOKEN ETH</option>
                <option value="qris_sol">TOKEN SOL</option>
            </select>
            <input type="file" id="inp-qris" class="hidden" onchange="previewQR(this)">
            <div onclick="document.getElementById('inp-qris').click()" class="border-2 border-dashed border-white/10 p-10 rounded-2xl cursor-pointer">
                <img id="prev-img" class="max-h-40 mx-auto hidden">
                <p id="up-txt" class="text-xs text-gray-500 uppercase font-black">Klik untuk Upload Gambar</p>
            </div>
            <button onclick="saveQRIS()" class="w-full py-4 bg-yellow-500 text-black font-black rounded-xl uppercase">Update Database</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, setDoc, addDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const config = { 
            apiKey: "AIzaSyDrpBJTtankyLgimtOwuriFpiyuC5K10OI", 
            authDomain: "studio-727777898-40aea.firebaseapp.com", 
            projectId: "studio-727777898-40aea", 
            appId: "1:351263967108:web:a0c01af41422903cc17fd1" 
        };
        const app = initializeApp(config);
        const db = getFirestore(app);

        let base64 = "", activeUID = "";

        // Navigasi
        window.st = (t) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active-nav'));
            document.getElementById('t-'+t).classList.add('active');
            document.getElementById('n-'+t).classList.add('active-nav');
        };

        // Saldo
        window.editBal = async (id, cur) => {
            const n = prompt("Input Saldo Baru:", cur);
            if(n) await updateDoc(doc(db, "users", id), { balance: parseInt(n) });
        };

        // QRIS
        window.previewQR = (el) => {
            const fr = new FileReader();
            fr.onload = (e) => { 
                base64 = e.target.result; 
                document.getElementById('prev-img').src = base64;
                document.getElementById('prev-img').classList.remove('hidden');
                document.getElementById('up-txt').classList.add('hidden');
            };
            fr.readAsDataURL(el.files[0]);
        };

        window.saveQRIS = async () => {
            const coin = document.getElementById('target-coin').value;
            if(!base64) return alert("Pilih gambar!");
            await setDoc(doc(db, "config", "payment"), { [coin]: base64 }, { merge: true });
            alert("QRIS " + coin + " Berhasil Diupdate!");
        };

        // Real-time Users & Chat
        onSnapshot(collection(db, "users"), (sn) => {
            const uBox = document.getElementById('user-list');
            const cBox = document.getElementById('contact-list');
            uBox.innerHTML = ''; cBox.innerHTML = '';
            sn.forEach(d => {
                const u = d.data();
                uBox.innerHTML += `<div class="glass p-4 rounded-2xl flex justify-between items-center">
                    <div><p class="text-[10px] font-bold opacity-50 uppercase">${u.email}</p><p class="text-xl font-black italic">Rp ${u.balance||0}</p></div>
                    <button onclick="editBal('${d.id}', ${u.balance||0})" class="bg-white text-black text-[9px] px-3 py-2 rounded-lg font-black uppercase tracking-tighter">Atur Saldo</button>
                </div>`;
                cBox.innerHTML += `<div onclick="openChat('${d.id}','${u.email}')" class="p-3 bg-white/5 rounded-xl text-[10px] cursor-pointer mb-2 font-bold uppercase truncate border border-transparent hover:border-yellow-500">${u.email?.split('@')[0]}</div>`;
            });
        });

        window.openChat = (uid, email) => {
            activeUID = uid;
            onSnapshot(query(collection(db, "users", uid, "chats"), orderBy("timestamp", "asc")), sn => {
                const box = document.getElementById('chat-box'); box.innerHTML = '';
                sn.forEach(m => {
                    const d = m.data();
                    const isAdmin = d.sender === 'admin';
                    box.innerHTML += `<div class="p-2 max-w-[80%] text-[10px] rounded-xl font-bold ${isAdmin?'bg-yellow-500 text-black self-end ml-auto':'bg-white/10 text-white self-start'}">${d.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendReply = async () => {
            const msg = document.getElementById('admin-msg');
            if(!activeUID || !msg.value) return;
            await addDoc(collection(db, "users", activeUID, "chats"), { sender: 'admin', text: msg.value, timestamp: serverTimestamp() });
            msg.value = '';
        };

        lucide.createIcons();
    </script>
</body>
</html>
